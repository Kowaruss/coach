<script type="module">
    import { db, collection, getDocs } from '../firebase.js';
    
    let questions = [];
    let currentQuestionIndex = 0;
    let answerShown = false;
    
    async function loadQuestions() {
        try {
            console.log("Загружаю вопросы из БД...");
            const querySnapshot = await getDocs(collection(db, "sops"));
            questions = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.question && data.options) {
                    questions.push(data);
                }
            });
            
            console.log("Загружено вопросов:", questions.length);
            
            if (questions.length > 0) {
                showRandomQuestion();
                setupActionButton();
            } else {
                document.getElementById('questionText').textContent = 'В базе данных пока нет вопросов.';
                document.getElementById('actionBtn').style.display = 'none';
            }
        } catch (error) {
            console.error("Ошибка загрузки:", error);
            document.getElementById('questionText').textContent = 'Ошибка загрузки вопросов из базы данных';
        }
    }
    
    function showRandomQuestion() {
        if (questions.length === 0) return;
        
        currentQuestionIndex = Math.floor(Math.random() * questions.length);
        const question = questions[currentQuestionIndex];
        
        // Показываем вопрос
        document.getElementById('questionText').textContent = question.question;
        
        // Показываем варианты ответов
        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';
        
        question.options.forEach((option, index) => {
            const optionElement = document.createElement('div');
            optionElement.className = 'option';
            optionElement.textContent = `${index + 1}. ${option}`;
            optionElement.style.color = '#2c3e50'; // обычный цвет
            optionElement.style.fontWeight = 'normal';
            optionsContainer.appendChild(optionElement);
        });
        
        // Скрываем блок ответа
        const answerElement = document.getElementById('answer');
        answerElement.innerHTML = '';
        answerElement.classList.remove('show');
        answerShown = false;
    }
    
    function setupActionButton() {
        const actionBtn = document.getElementById('actionBtn');
        const options = document.querySelectorAll('.option');
        
        actionBtn.addEventListener('click', function() {
            if (!answerShown) {
                // Подсвечиваем правильный вариант зелёным, неправильные - серым
                const correctIndex = questions[currentQuestionIndex].correctAnswer;
                options.forEach((option, index) => {
                    if (index === correctIndex) {
                        option.style.color = '#28a745';
                        option.style.fontWeight = 'bold';
                    } else {
                        option.style.color = '#95a5a6';
                    }
                });
                
                actionBtn.textContent = 'Следующий вопрос';
                answerShown = true;
            } else {
                // Показываем следующий вопрос
                showRandomQuestion();
                actionBtn.textContent = 'Покажи ответ';
            }
        });
    }
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', loadQuestions);
</script>
